-- LocalScript: TheRobGUI (StarterGui)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local remote = ReplicatedStorage:WaitForChild("RobGuiRemote")
local player = Players.LocalPlayer

-- Crear GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "TheRobGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 220)
frame.Position = UDim2.new(0.05, 0, 0.2, 0)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
title.Text = "THE ROB GUI"
title.Font = Enum.Font.Code
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(0,0,0)
title.Parent = frame

local function makeButton(text, y)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1, -12, 0, 40)
    b.Position = UDim2.new(0, 6, 0, y)
    b.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    b.TextColor3 = Color3.fromRGB(0, 255, 0)
    b.Font = Enum.Font.Code
    b.TextScaled = true
    b.Text = text
    b.Parent = frame
    return b
end

local btnSky = makeButton("üî¥ Set SkyBlox", 50)
local btnEnd = makeButton("‚ò†Ô∏è The End Is Near", 100)
local btnOff = makeButton("‚õî Apagar efectos", 150)

-- Mensajes de estado en el GUI
local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -12, 0, 20)
status.Position = UDim2.new(0, 6, 0, 195)
status.BackgroundTransparency = 1
status.TextColor3 = Color3.fromRGB(0,255,0)
status.Font = Enum.Font.Code
status.TextScaled = false
status.Text = ""
status.Parent = frame

-- Dragging (arrastrable)
local gui = frame
local dragging, dragStart, startPos

gui.Active = true

gui.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = gui.Position
    end
end)

gui.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        local delta = input.Position - dragStart
        gui.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- Funciones de botones (env√≠an solicitudes al servidor)
btnSky.MouseButton1Click:Connect(function()
    status.Text = "Activando Set SkyBlox..."
    remote:FireServer("SetSkyBlox")
    wait(0.6)
    status.Text = "Set SkyBlox enviado"
    wait(2)
    status.Text = ""
end)

btnEnd.MouseButton1Click:Connect(function()
    status.Text = "Activando The End Is Near..."
    remote:FireServer("TheEndIsNear")
    wait(0.6)
    status.Text = "The End Is Near enviado"
    wait(2)
    status.Text = ""
end)

btnOff.MouseButton1Click:Connect(function()
    status.Text = "Apagando efectos..."
    remote:FireServer("RestoreEffects")
    wait(0.6)
    status.Text = "Solicitud de restauraci√≥n enviada"
    wait(2)
    status.Text = ""
end)
-- Server Script: TheRobGUI_Server (ServerScriptService)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")

local remote = ReplicatedStorage:WaitForChild("RobGuiRemote")

-- Storage para restaurar
local backup = {
    lighting = nil,     -- guardaremos valores originales una sola vez
    sky = nil,
    parts = {},         -- [part] = {Color = Color3, Material = Enum, addedDecals = {decals...}}
    modified = false
}

-- Funci√≥n para obtener thumbnail (headshot)
local function getPlayerHeadTexture(userId)
    -- GetUserThumbnailAsync devuelve (url, ready)
    local thumbType = Enum.ThumbnailType.HeadShot
    local thumbSize = Enum.ThumbnailSize.Size420x420
    local success, url = pcall(function()
        return Players:GetUserThumbnailAsync(userId, thumbType, thumbSize)
    end)
    if success then
        return url
    else
        return nil
    end
end

-- Funci√≥n: Set SkyBlox (cambia el cielo globalmente)
local function setSkyBlox(player)
    local url = getPlayerHeadTexture(player.UserId)
    if not url then return end

    -- Guardar lighting original si no est√° guardado
    if not backup.lighting then
        backup.lighting = {
            Ambient = Lighting.Ambient,
            OutdoorAmbient = Lighting.OutdoorAmbient,
            Brightness = Lighting.Brightness,
            ClockTime = Lighting.ClockTime
        }
    end

    -- Guardar sky original una vez
    if not backup.sky then
        backup.sky = Lighting:FindFirstChildOfClass("Sky")
        -- not cloning original sky here, just store reference (we will remove/replace)
    end

    -- Crear nuevo Sky
    local sky = Instance.new("Sky")
    sky.Name = "RobGui_Sky"
    sky.SkyboxBk = url
    sky.SkyboxDn = url
    sky.SkyboxFt = url
    sky.SkyboxLf = url
    sky.SkyboxRt = url
    sky.SkyboxUp = url
    sky.Parent = Lighting

    -- Aplicar luz roja ambiente
    Lighting.Ambient = Color3.fromRGB(150, 0, 0)
    Lighting.OutdoorAmbient = Color3.fromRGB(80, 0, 0)
    Lighting.Brightness = 2
    Lighting.ClockTime = 14

    backup.modified = true
end

-- Funci√≥n: The End Is Near (cambia mapa excepto avatar del ejecutor y cielo)
local function theEndIsNear(player)
    local url = getPlayerHeadTexture(player.UserId)
    if not url then return end

    -- Guardar lighting original si no est√° guardado
    if not backup.lighting then
        backup.lighting = {
            Ambient = Lighting.Ambient,
            OutdoorAmbient = Lighting.OutdoorAmbient,
            Brightness = Lighting.Brightness,
            ClockTime = Lighting.ClockTime
        }
    end

    -- Cambiar ambiente leve (no el cielo)
    Lighting.Ambient = Color3.fromRGB(120, 0, 0)
    Lighting.OutdoorAmbient = Color3.fromRGB(60, 0, 0)
    Lighting.Brightness = 1.5

    -- Iterar y modificar partes del mapa
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") then
            -- Omitir partes que pertenezcan al personaje del ejecutor
            local char = player.Character
            if char and (obj:IsDescendantOf(char)) then
                -- saltar la parte del ejecutor
            else
                -- Guardar las propiedades originales la primera vez que lo tocamos
                if not backup.parts[obj] then
                    backup.parts[obj] = {
                        Color = obj.Color,
                        Material = obj.Material,
                        addedDecals = {}
                    }
                end

                -- Cambiar color y material
                obj.Color = Color3.fromRGB(255, 0, 0)
                obj.Material = Enum.Material.ForceField

                -- A√±adir decal con la imagen del avatar (marcada para borrado luego)
                local decal = Instance.new("Decal")
                decal.Name = "ROB_DECAL_" .. tostring(player.UserId)
                decal.Texture = url
                -- Debemos elegir una cara que funcione; Front es buena opci√≥n
                decal.Face = Enum.NormalId.Front
                decal.Parent = obj

                table.insert(backup.parts[obj].addedDecals, decal)
            end
        end
    end

    -- Crear el BillboardGui sobre la cabeza del ejecutor
    local character = player.Character or player.CharacterAdded:Wait()
    local head = character:FindFirstChild("Head")
    if head then
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ROB_Billboard_THE_END"
        billboard.Size = UDim2.new(0, 220, 0, 60)
        billboard.Adornee = head
        billboard.AlwaysOnTop = true
        billboard.Parent = character -- parent to character so it's visible to all

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.Text = "rob666 THE END"
        label.TextScaled = true
        label.Font = Enum.Font.GothamBlack
        label.TextColor3 = Color3.fromRGB(255,0,0)
        label.Parent = billboard
    end

    backup.modified = true
end

-- Funci√≥n: Restaurar efectos originales
local function restoreEffects()
    -- Restaurar lighting
    if backup.lighting then
        Lighting.Ambient = backup.lighting.Ambient
        Lighting.OutdoorAmbient = backup.lighting.OutdoorAmbient
        Lighting.Brightness = backup.lighting.Brightness
        Lighting.ClockTime = backup.lighting.ClockTime
        backup.lighting = nil
    end

    -- Remover sky creado
    local sky = Lighting:FindFirstChild("RobGui_Sky")
    if sky then
        sky:Destroy()
    end
    -- (No restauramos sky original autom√°ticamente si era distinto; original sky stored as reference
    -- could be re-parented if needed ‚Äî for simplicidad, no lo recreamos.)

    -- Restaurar partes modificadas
    for part, data in pairs(backup.parts) do
        if part and part.Parent then
            if data.Color then pcall(function() part.Color = data.Color end) end
            if data.Material then pcall(function() part.Material = data.Material end) end
            -- Borrar decals que a√±adimos
            for _, decal in ipairs(data.addedDecals) do
                if decal and decal.Parent then
                    pcall(function() decal:Destroy() end)
                end
            end
        end
    end
    backup.parts = {}

    -- Borrar billboards creados (por nombre)
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Character then
            local bb = p.Character:FindFirstChild("ROB_Billboard_THE_END")
            if bb then
                pcall(function() bb:Destroy() end)
            end
        end
    end

    backup.modified = false
end

-- RemoteEvent listener
remote.OnServerEvent:Connect(function(player, action)
    if action == "SetSkyBlox" then
        -- Ejecutar en protecci√≥n pcall: por si ocurre error en GetUserThumbnailAsync
        local ok, err = pcall(function() setSkyBlox(player) end)
        if not ok then
            warn("SetSkyBlox error: ", err)
        end
    elseif action == "TheEndIsNear" then
        local ok, err = pcall(function() theEndIsNear(player) end)
        if not ok then
            warn("TheEndIsNear error: ", err)
        end
    elseif action == "RestoreEffects" then
        local ok, err = pcall(function() restoreEffects() end)
        if not ok then
            warn("RestoreEffects error: ", err)
        end
    end
end)

